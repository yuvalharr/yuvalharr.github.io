<!DOCTYPE html>
<html>
<head>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-resize.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-animation.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-virtual-chin.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-new-virtual-chin.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-new-resize.js"></script>
    
    <script src="jspsych-6.1.0/plugins/jspsych-brms.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-brms-test.js"></script>

    <script src= "jspsych-6.1.0/jquery.min.js"></script>
    <script src= "jspsych-6.1.0/jquery-ui.min.js"></script>
    <script src= "jspsych-6.1.0/svg.min.js"></script>
    <link href="jspsych-6.1.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"></link> 
    <link href="jspsych-6.1.0/css/jquery-ui.css" rel="stylesheet" type="text/css"></link>
    <link href="jspsych-6.1.0/css/styles.css" rel="stylesheet" type="text/css"></link>
    <!--
    <script src="jspsych-6.1.0/lib/jquery-min.js" type="text/javascript"></script>

    -->  
    <script src="jspsych-6.1.0/lib/underscore-min.js" type="text/javascript"></script>
  
    <script src="jspsych-6.1.0/lib/backbone-min.js" type="text/javascript"></script>
  
    <script src="jspsych-6.1.0/lib/TweenMax.min.js"></script>
    <script src="jspsych-6.1.0/lib/CustomEase.js"></script>

    <script src="js/utils.js" type="text/javascript"></script>     

    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<body></body>

<script>
document.body.style.backgroundColor = "ghostwhite";

// Change Blindness paramaters
var num_img_pairs = 2,   // ENTER NUMBER OF STIMULI HERE
    wrong_answers_message = 2, // at this num of wrong answers, every wrong answer will get a warning message (including this num)
    wrong_answers_abort = 4 // at this num of wrong answers, the exp will be aborted

// BRMS parameters
var total_num_faces = 2, // total number of faces in the database (images file) *yuval
    train_repetitions = 1, // number of repeats of the practice procedure (at this point 4 stimuli)
    ITI = 1000,
    time_limit = 60 * (60 * 1000),
    stimAlphas = 0.4,
    unitSize = 4,
    breakEvery = 20,
    repetitions = 1, // number of repetitions of each face   *yuval    
    train_alpha = 0.4,
    trialLength = 0, // 0 is no limit
    fade_in_time = 1,
    fade_out_time = 20,
    fade_out_length = 10,
    training_allowed_repeat = 1,
    experiment_performance_thresh = .80,
    experiment_performance_trials = 10,
    train_performance_thresh = .80,     ///////remember to return to 0.85
    experiment_RT_trials = 8, // only after this number of trials look at RT thresholds
    experiment_RT_trial_threshold = 5, // number of allowed 'too fast' trials. More then this will bring a warning
    experiment_RT_threshold = 300, // less ms then this will be marked 'too fast'
    sProblemCrit = 8,
    bProblemCrit = 2;

var CONDITION = Math.random() >= 0.5; //change when condition is assigned through cognition.run
if (CONDITION == 1) {
  CONDITION = 1
} else {
  CONDITION = 2
} // can delete all of this up when assigned through cognition.run

var q1 =""
    q2="",
    q3="",
    q4="";

if (CONDITION == 1) {
  q1 = " (detecting flickering objects in scenes)?"
  q2 = "objects"
  q3 = " (detecting faces)?"
  q4 = "faces"
} else {  
  q1 = " (detecting faces)?"
  q2 = "faces"
  q3 = " (detecting flickering objects in scenes)?"
  q4 = "objects"
}
//#region CHANGE BLINDNESS PART
//#region Change Blindness stimuli preperation
function replicate(arr, times) { // function to help make array of many 'L's and 'R's 
     var al = arr.length,
         rl = al*times,
         res = new Array(rl);
     for (var i=0; i<rl; i++)
         res[i] = arr[i % al];
     return res;
}

var absent_images = [],
    present_images = [],
    detection_images = [],
    L_R_array = ['L', 'R'], // L & R array to replicate many times in the next row 
    random_var = replicate(L_R_array, num_img_pairs/2); // make half of the array 'L's and half 'R's
    random_var = jsPsych.randomization.shuffle(random_var); // random_var is now shuffled to assign each trial with L or R couple of images
for (i = 1; i <= num_img_pairs; i++) { //YH- creating two arrays -> one for all 'absent' and one for all 'present' images  -YH
  absent_images.push('img/0' + i + '_' + random_var[i-1] + '_filler_absent' + '.jpg');
  present_images.push('img/0' + i + '_' + random_var[i-1] + '_filler_present' + '.jpg');
  detection_images.push('detection grids/0' + i + random_var[i-1] + '.jpg')
}

// YH - make answers_L array *manually*. *** First value is column. second is row ***

answers_L =[]
answers_L.push([1,1]) // img_1
answers_L.push([1,3])
answers_L.push([1,2])
answers_L.push([1,0])
answers_L.push([0,3]) // img_5  
answers_L.push([0,2])
answers_L.push([1,2]) 
answers_L.push([1,2])
answers_L.push([0,1])
answers_L.push([0,0]) // img 10
answers_L.push([0,1])
answers_L.push([0,2])
answers_L.push([0,1])
answers_L.push([1,1])
answers_L.push([0,0]) // img 15  
answers_L.push([0,2])
answers_L.push([1,0])
answers_L.push([1,3])
answers_L.push([1,3])
answers_L.push([0,2]) // img 20 
answers_L.push([0,2])
answers_L.push([0,2])
answers_L.push([1,2])
answers_L.push([1,2])
answers_L.push([1,0]) // img 25
answers_L.push([1,1]) 
answers_L.push([0,1])
answers_L.push([0,2])
answers_L.push([0,2])
answers_L.push([1,0]) // img_30  
answers_L.push([0,2])
answers_L.push([1,1]) 
answers_L.push([0,2])
answers_L.push([0,0])
answers_L.push([1,2]) // img 35
answers_L.push([0,3])
answers_L.push([1,3])
answers_L.push([1,1])
answers_L.push([1,1])
answers_L.push([1,1]) // img 40 



// Make function to take L answers and make into R
function flipToR (L_ans) {
  var R_ans = []
  R_ans = L_ans
  if (R_ans[0] == 0) {
    R_ans[0] = 3
  } else {
    if (R_ans[0] == 1) {
      R_ans[0] = 2
    } else {
      if (R_ans[0] == 2) {
        R_ans[0] = 1
      } else {
        R_ans[0] = 0
      }
    }
  }
  return R_ans;
}

// Make answers_R array *automatically*
var answers_R = []
for (i = 0, len = answers_L.length; i < len; i++) {
    answers_R[i] = answers_L[i].slice();
}
for (i = 0; i < answers_L.length; i++) {
  answers_R[i] = flipToR (answers_R[i])
}

// YH- stimuli array preperation
var coupled = [];                  // make 'coupled' array -> each item is an array of coupled (a & b) images
for(var i=0; i < absent_images.length; i++){
   coupled.push([absent_images[i], present_images[i], detection_images[i]]);
   if (detection_images[i].slice(-5, -4) == "L") { // assign each coupled[i] with *only* its appropriate side answers (L or R)
     coupled[i].push(answers_L[i])
   } else {
    coupled[i].push(answers_R[i])
   }
}
coupled = jsPsych.randomization.shuffle(coupled); // shuffle 'coupled' array

// YH- prepare stimuli for the timeline in an array

var timeline_stimuli = []
var pre_load_list = []   // YH - array of images names for preload_images in the init function

for(var i=0; i < coupled.length; i++){     // make timeline - YH
    timeline_stimuli.push({stimuli: [coupled[i][0], coupled[i][0], coupled[i][1], coupled[i][1]], 
                             detection_image: [coupled[i][2]],
                             answers: coupled[i][3]
                             } 
                         );
    
    pre_load_list.push(timeline_stimuli[i]["stimuli"], timeline_stimuli[i]["detection_image"]);
}
//#endregion Change Blindness stimuli preperation
//#region add zoom events to data

var zoom_event = [];

window.onresize = function(){
  console.log(window.devicePixelRatio);
  zoom_event.push({timestamp: performance.now(), zoom_ratio: window.devicePixelRatio});
}
//#endregion add zoom events to data


var postCalibText = [
  {
    stimulus: ["<p style='font-size: 28px;' align='justify'>We finished the calibration stage! We will now continue to the main task of this experiment.</p>\
                <p style='font-size: 28px;' align='justify'><b>We remind you to make an effort to move as little as possible until the end of the task.</b></p>\
                <p style='font-size: 28px;'><b>Please read the following instructions carefully.</b></p>\
    <p style='font-size: 24px;'><i>Press the space bar to continue to the instructions</i></p>"],
    choices: [32]
  }
]
var CBinstructionsText = [
  
  {
    stimulus: ["<p style='font-size: 28px;' align='justify'>In this part you will be asked to find a single flickering object within a scene.\
    Each time you will be presented with one scene. This scene will be static, except for one single object that will be appearing and disappearing.\
    Your goal will be to detect this object as quickly and accurately as you can.</p>\
    <p style='font-size: 28px;' align='justify'>We will ask you to place your finger over the space bar, and once you have found the object press the space bar <b>as quickly as possible.</b></p>\
    <p style='font-size: 28px;' align='justify'>For each scene, you will have 60 seconds to do so. After that you will be asked about the location of the object.</P>\
    <br>\
    <p style='font-size: 28px;'>We will now continue with a short practice before starting the main task.</p>\
    <br>\
    <p style='font-size: 24px;'><i>Press the space bar to continue</i></p>"],
    choices: [32]
  }
  
  
];

var CBinPracticeText = [
  {
    stimulus: ["<p style='font-size: 28px;'>That was easy, right?</p>\
                <p style='font-size: 28px;'>Now let's have another practice. This time it will be a bit more difficult.</p>\
                <p style='font-size: 24px;'><i>Press the space bar to continue</i></p>"],
    choices: [32]
  }
    
];

var CBafterPracticeText = [
  {
    stimulus: ["<p style='font-size: 28px;'>Great! You are now ready to continue to the main task.</p>\
                <p style='font-size: 28px;'>You will now be shown a series of similar trials one after another.</p>\
                <p style='font-size: 28px;'>It will take about 10-15 minutes until the next break.</p>\
                <p style='font-size: 28px;'>We ask you to keep your finger over the space bar and stay concentrated the whole time.</p>\
                <p style='font-size: 24px;'><i>Press the space bar when ready</i></p>"],
    choices: [32]
  }
    
];

var introduction_procedure = {
    timeline: [
        {
            type: 'fullscreen',
            fullscreen_mode: true,
            message: '<p>You are asked to to enter full-screen mode once again.</p>\
            <p>Please do not leave full-screen mode at any time throughout the experiment.</p>',
            button_label: 'Enter full-screen'
        },
        {
            type: 'call-function',
            func: function() {
                var urlvar = jsPsych.data.urlVariables();
                var id = urlvar.id
                var card_width_px = Number(urlvar.width)
                var distance = Number(urlvar.distance)
                jsPsych.data.addProperties({id: id, card_width_px: card_width_px, distance: distance, condition: CONDITION})
            }
        },
        {
            type: 'new-resize',
            item_width: 3 + 3/8,
            item_height: 2 + 1/8,
            prompt: "<p>Click and drag</p>",
            pixels_per_unit: 150, // YH - check what to put here
            card_width_px: function(){  
              var last_trial_card_width =  jsPsych.data.get().last(2).values()[0].card_width_px; // card width in px from previous trial
              return last_trial_card_width; 
            } 
        }, 
        {
            type: 'animation',    // YH -this trial is here just to enable exp to advance from virtual-chin to html-keyboard-response- YH **
            stimuli: ['img/demo1_absent.jpg'],
            choices: [32],
            sequence_reps: 1,
            frame_isi: 0,
            frame_time: 0.05,
            prompt: '<p style="font-size: 28px;"></p>',
        },
        {
            type: 'html-keyboard-response',
            timeline: postCalibText,
            timing_post_trial: 400
        }
                
    ]
}


var CB_practice_procedure = {
    timeline: [
        {
            type: 'html-keyboard-response',
            timeline: CBinstructionsText,
            timing_post_trial: 400
        },
        {
            type: 'animation',
            stimuli: ['img/demo1_absent.jpg','img/demo1_absent.jpg', 'img/demo1_present.jpg', 'img/demo1_present.jpg'],
            choices: [32],
            sequence_reps: 30,
            frame_isi: 0,
            frame_time: 500,
            prompt: '<p></p> \<p style="font-size: 28px;">Press the <b>space bar</b> quickly after finding the flickering object</p>',
            on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
            on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            },
            data: {
                training: true
            }

        },
        {
            type: 'image-button-response',
            stimulus: ['detection grids/demo1.jpg'],
            choices: ['A', 'B', 'C', 'D', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>column</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px',
            data: {
                training: true
            }
        },
        {
            type: 'image-button-response',
            stimulus: ['detection grids/demo1.jpg'],
            choices: ['1', '2','3','4', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>row</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px',
            data: {
                training: true
            }
        },
        {
            type: 'html-keyboard-response',
            timeline: CBinPracticeText,
            timing_post_trial: 1200
        },
        {
            type: 'animation',
            stimuli: ['img/demo2_absent.jpg','img/demo2_absent.jpg', 'img/demo2_present.jpg', 'img/demo2_present.jpg'],
            choices: [32],
            sequence_reps: 47, 
            frame_isi: 80,
            frame_time: 240,
            timing_post_trial: 1200,
            prompt: '<p style="font-size: 28px;">Press the <b>space bar</b> quickly after finding the flickering object</p>',
            on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
            on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            },
            data: {
                training: true
            }
        },
        {
          type: 'image-keyboard-response',
            stimulus: ['detection grids/demo2.jpg'],
            choices: [32],
            prompt: '<p></p> \
                    <p style="font-size: 24px"><b>When asked about the location, sometimes more then one answer may seem possible.</p>\
                    <p style="font-size: 24px">In any case like this, choose the option in which the major part of the object is located.</b></p>\
                    <p style="font-size: 24px">Press the space bar to continue</p>',
            stimulus_width: '900'
        },
        {
            type: 'image-button-response',
            stimulus: ['detection grids/demo2.jpg'],
            choices: ['A', 'B', 'C', 'D', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>collumn</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px',
            data: {
                training: true
            }
        },
        {
            type: 'image-button-response',
            stimulus: ['detection grids/demo2.jpg'],
            choices: ['1', '2','3','4', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>row</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px',
            data: {
                training: true
            }
        },
        {
            type: 'html-keyboard-response',
            timeline: CBafterPracticeText,
            
        }

    ]
}

var warning_trial = {      // warning message to display after too many wrong answers
    type: 'html-keyboard-response',
    stimulus: "<div class = 'center'><p style='font-size: 28px;'>It seems that you are not performing the task as instructed.</p>\
      <p style='font-size: 28px;'>You are reminded to press the space bar only if you have spotted the flickering object.</p>\
      <p style='font-size: 28px;'>If it keeps recurring we might need to end the experiment.</p> \
      <p style='font-size: 24px;'><i>Press the space bar to continue</i></p>",
    on_finish: function() {
      new_wrong_answers--;
    }
      
}

var abort_trial = {
  type: 'html-keyboard-response',
  stimulus: "<div class = 'center'><p style='font-size: 28px;'>The task is still not being performed as instructed despite multiple warnings.</p> \
            <p style='font-size: 28px;'>The experiment will be aborted now.</p> \
            <p style='font-size: 28px;'>If you feel that this is a mistake, please email us at <i>yuval.harris@mail.huji.ac.il</i> or contact us via MTurk.</p> \
            <p style='font-size: 24px;'>Press the space bar to quit</p>",
  choices: [32],
  on_finish: function(){
    jsPsych.endExperiment('The experiment was aborted');
  } 
}

var new_wrong_answers = 0; // num of wrong answers used to display warning message when needed. after each message will decrease by 1 to allow trials with unnecessary message
var total_wrong_answers = 0; // total num of wrong answers (never decreases)

var CB_trial_procedure = {
    timeline: [
        {
              
              type: "call-function",
              async: true,
              func: function(done) {
                jsPsych.pluginAPI.preloadImages(jsPsych.timelineVariable('stimuli', true), function() {
                  done({ preload: "success" });
                })
                jsPsych.pluginAPI.preloadImages(jsPsych.timelineVariable('detection_image', true), function() {
                  done({ preload: "success" });
                })
              }

        },
        {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">ready?</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
            prompt: '<p style="font-size: 36px;">3</p>',
            on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            }
        },
        {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">ready?</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
            prompt: '<p style="font-size: 36px;">3</p>'
        },
        {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">ready?</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
            prompt: '<p style="font-size: 36px;">2</p>'
        },
        {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">ready?</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
            prompt: '<p style="font-size: 36px;">1</p>',
            post_trial_gap: 0
        },
        {
            type: 'animation',
            stimuli: jsPsych.timelineVariable('stimuli'),
            choices: [32],
            sequence_reps: 47,
            frame_isi: 80,
            frame_time: 240,
            data: {
              col_row_answers: jsPsych.timelineVariable('answers')
              },
            on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            }
        },
        {
            type: 'image-button-response',
            stimulus: jsPsych.timelineVariable('detection_image'),
            choices: ['A', 'B', 'C', 'D', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>column</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px',
            on_finish: function(data) {
                if ( data.button_pressed == jsPsych.data.get().last(2).values()[0].col_row_answers[0] ) { // if button pressed was correct 
                  data.correct_response = true;
                } else {
                  data.correct_response = false;
                  if (jsPsych.data.get().last(2).values()[0].rt ) {   // only if there was response during trial (=rt exists),
                    total_wrong_answers++; // if wrong, add 1 to wrong answers count
                    new_wrong_answers++;
                  }
                }
            }
        },
        {
            type: 'image-button-response',
            stimulus: jsPsych.timelineVariable('detection_image'),
            choices: ['1', '2','3','4', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>row</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px',
            on_finish: function(data) {
                var all_data = jsPsych.data.get().values();
                if ( data.button_pressed == jsPsych.data.get().last(3).values()[0].col_row_answers[1] ) { //if button pressed is correct
                  data.correct_response = true;
                  if (jsPsych.data.get().last(2).values()[0].correct_response == true) { // If both grids were correct ->
                    
                    // go back 2 trials, which means subtracting 2 from the array length, and 1 more to account for the 0 indexing
                    all_data[all_data.length-3].success = true; 
                  } else {
                    all_data[all_data.length-3].success = false; 
                  }
                } else {
                  all_data[all_data.length-3].success = false; 
                  data.correct_response = false;
                  if (jsPsych.data.get().last(3).values()[0].rt ) { // only if there was response during trial (rt exists)
                    if (jsPsych.data.get().last(2).values()[0].correct_response == true) { // in the second grid trial, add 1 only if previous grid was
                      total_wrong_answers++;                                                 //  correct, to not count twice wrong answers in same stimuli.
                      new_wrong_answers++;
                  }
                  
                  } else {
                    all_data[all_data.length-3].success = null; // if there was no answer during trial - don't call it FALSE.
                  }
                }
            }
        },
        {
            timeline: [abort_trial],
            conditional_function: function(){
                if (jsPsych.data.get().last(3).values()[0].responses) {
                  if (total_wrong_answers >= wrong_answers_abort) {
                    return true
                  } else {
                     return false
                  }
                } else {
                  return false
                }          
            }
        },
        {
            timeline: [warning_trial],
            conditional_function: function(){
                if (jsPsych.data.get().last(3).values()[0].responses) {
                  if (new_wrong_answers >= wrong_answers_message) {
                    return true;
                  } else {
                     return false
                  }
                } else {
                  return false
                }          
            }
        }
    ],
    timeline_variables: timeline_stimuli // Declare timeline_stimuli as timeline of the experiment
}

//#endregion CHANGE BLINDNESS PART
var middle_study_text = [
  {
    stimulus: ["<p style='font-size: 28px;'>First part is done!</p>\
    <p style='font-size: 28px;'>You've finished about half of the study, great job!</p>\
    <p style='font-size: 24px;' align='center'><i>Press the space bar to continue.</i></p>"],
    choices: [32]
  },
  {
    stimulus: ["<p style='font-size: 28px;'>We will now go on to the second task.</p>\
    <p style='font-size: 28px;'>Please read the following instructions carefully.</p>\
    <p style='font-size: 24px;' align='center'><i>Press the space bar to continue.</i></p>"],
    choices: [32]
  },
]

var middle_instructions = {
  type: 'html-keyboard-response',
  timeline: middle_study_text,
  timing_post_trial: 200
};
//#region BRMS PART

//#region BRMS practice

var bRMS_instruction_text = [
  {
    stimulus: ["<div class = 'center'><p style='font-size: 28px;'>In this task you will be presented with rapidly \
      changing patterns of rectangles. Through these rectangles faces will appear. Your task will be to indicate the location of \
      the faces, or any part of them, as soon as they appear.</p>\
      <p style='font-size: 24px;' align='center'><i>Press the space bar to continue.</i></p></div>"
    ],
    choices: [32]
  },
  {
    stimulus: ["<div class = 'center'><p style='font-size: 28px;'>If a face appeared in the right half \
      of the screen, press the right key. If a face appeared in the left half \
      of the screen, press the left key.</p>\
      <p style='font-size: 24px;' align='center'><i>Press the space bar to continue.</i></p></div>"
    ],
    choices: [32]
  } ,
  {
    stimulus: ["<div class = 'center'><p style='font-size: 28px;'>Please perform this task as accurately \
      and quickly as you can.</p>\
      <p style='font-size: 24px;' align='center'><i>Press the space bar to continue.</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class = 'center'><p style='font-size: 28px;'>During the task, please focus your gaze at\
       the plus sign in the middle.</p> \
       <p style='font-size: 28px;'>Even though the faces appear to the left and right of the plus sign, it is important that you look at the plus \
        sign at all times.</p>\
        <p style='font-size: 24px;' align='center'></i>Press the space bar to continue.</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class = 'center'><p style='font-size: 28px;'>We will start with a short practice.</p>\
        <p style='font-size: 24px;' align='center'></i>Press the space bar to continue.</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class='center'>\
      <img src='keys.jpg'></img>\
      <p style='font-size: 28px;'>Place your fingers on the 'D' and 'K' keys as shown in the picture.</p> \
      <p style='font-size: 28px;'>If a face appears on the right side press the right key (K).</p>\
      <p style='font-size: 28px;'>If a face appears on the left side press the left key (D).</p>\
      <p>Press either one of these keys to start the practice.</p></div>"],
    choices: [68, 75]
  }
];

var practice_stimuli = [];
for (i = 0; i < train_repetitions; i++) { //make train stim timeline
    practice_stimuli.push({stimuli: "faces/training/p_" + i + ".jpg"})
}
var bRMS_instructions = {
  type: 'html-keyboard-response',
  timeline: bRMS_instruction_text,
  timing_post_trial: 200
};

var bRMS_practice_procedure = {
  timeline: [
    {
      type: "bRMS",
      stimulus: jsPsych.timelineVariable('stimuli'),
      timing_response: trialLength,
      fade_out_time: fade_out_time,
      fade_in_time: fade_in_time,
      fade_out_length: fade_out_length,
      stimulus_alpha: train_alpha,
      timing_post_trial: 100,
      visUnit: function() {
        return unitSize
      },
      within_ITI: ITI - 100,
      colorOpts: ['#FF0000', '#00FF00', '#0000FF',
                       '#FFFF00', '#FF00FF', '#00FFFF'
                     ],
      on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
      on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            },
      data: {
          //stimulus: jsPsych.timelineVariable('practice_stimuli'),
          training: true,
          timing_response: trialLength,
          fade_out_time: fade_out_time,
          fade_in_time: fade_in_time,
          fade_out_length: fade_out_length,
          stimulus_alpha: train_alpha
      } 
    }
  ],
  timeline_variables: practice_stimuli,
  randomize_order: true
  
};
 
var performanceMSG_practice = {
    type: 'html-keyboard-response',
    stimulus: ["<div class='center'>\
  <p style='font-size: 28px;'>You pressed the wrong key too many times during the practice block.</p>\
  <p style='font-size: 24px;'>Press either the 'D' or 'K' keys to repeat it.</p></div>"],
    choices: [68, 75],
    on_start: function(trial) {
      if (jsPsych.data.get().last(1).select('trial_type').values != 'bRMS') {
        trial.stimulus = '';
        trial.choices = jsPsych.NO_KEYS;
        trial.trial_duration = 0;
      }
    }
  },
  stop_practice_loop = {
    type: 'html-keyboard-response',
    conditional_function: function() {
      if (jsPsych.data.get().last(1).select('train_repeats').values[0] > training_allowed_repeat) {
          if (jsPsych.data.get().last(train_repetitions).select('acc').mean() < train_performance_thresh) {
              return true
          }
        else {
            return false;
        }
      } else {
        return false;
      }
    },
    timeline: [{
      stimulus: "<div class='center'>\
  <p style='font-size: 28px;'>It seems that you are not performing the task as instructed.</p>\
  <p style='font-size: 28px;'>Please return this study.</p>\
  <p style='font-size: 28px;'>If you feel that this is a mistake, please email us at \
  yuval.harris@mail.huji.ac.il or contact us via MTurk</p>\
  <p style='font-size: 28px;'>Press the space bar to continue.</p></div>"
    }],
    choices: [32],

    //** needed eventualy **//
    on_finish: function() {
          jsPsych.endExperiment('The experiment was aborted');  
			}
	}



jsPsych.data.addProperties({
  train_repeats: 1
});

var bRMS_secChanceLoop = {
  timeline: [performanceMSG_practice, bRMS_practice_procedure, stop_practice_loop],
  loop_function: function() {
    if (jsPsych.data.get().last(train_repetitions).select('acc').mean() < train_performance_thresh) {
      jsPsych.data.addProperties({
        train_repeats: jsPsych.data.get().last(1).select('train_repeats').values[0] + 1
      });
      return true
    } else {
      return false
    }
  }
};

//#endregion BRMS practice
//#region BRMS main task

var bRMS_mainBlockText = [{
    stimulus: ["<div class = 'center'><p style='font-size: 28px;'>You have completed the practice block.</p>\
  <p style='font-size: 28px;'>You will now continue with the same task. The task may now be more \
  difficult. It will take about 5-10 minutes, and you will have a short break in the half way point. </p>\
    <p style='font-size: 24px;'>Press either the 'D' or the 'K' keys to continue.</p></div>"],
    choices: [68, 75]
  },
  {
    stimulus: ["<div class = 'center'><p style='font-size: 28px;'>During the task, please focus your gaze at\
   the plus sign in the middle.</p> \
   <p style='font-size: 28px;'>Even though the faces appear to the left\
    and right of the plus sign, it is important that you look at the plus \
    sign at all times.</p>\
    <p style='font-size: 24px;'>Press either the 'D' or the 'K' keys to continue.</p></div>"],
    choices: [68, 75]
  }
]

var bRMS_mainBlockIns = {
  type: 'html-keyboard-response',
  timeline: bRMS_mainBlockText,
  timing_post_trial: 200
}

//** brms main block**//

// Define stimuli for bRMS


var used_images = [] //creating 'used_images[]', holding all and only faces going to be used in the main block. *yuval
for (i = 1; i <= total_num_faces; i++) {
    used_images.push('faces/' + i + '.jpg')
}
var brms_task_stimuli = [];


for (i = 0; i < repetitions; i++) { // Create a list of trials, repeating the experiment block x amount of times. *yaniv
  used_images = jsPsych.randomization.shuffle(used_images); //shuffling again for next repeats  *yuval
  for (ii = 0; ii <= used_images.length - 1; ii++) {
    brms_task_stimuli.push({
      type: "bRMS",
      stimulus: used_images[ii],
      data: {
        stimulus: used_images[ii],
        timing_response: trialLength,
        stimulus_alpha: stimAlphas,
        timing_post_trial: 100,
        within_ITI: ITI - 100,
        fade_in_time: fade_in_time,
        fade_out_time: fade_out_time,
        fade_out_length: fade_out_length,
        trial: (i * used_images.length) + ii + 1 // set trial number in data (example: 301,302...) *yuval
	    },
      stimulus_alpha: stimAlphas,
      timing_post_trial: 100,
      within_ITI: ITI - 100,
      timing_response: trialLength,
      fade_in_time: fade_in_time,
      fade_out_time: fade_out_time,
      fade_out_length: fade_out_length,
      colorOpts: ['#FF0000', '#00FF00', '#0000FF',
                       '#FFFF00', '#FF00FF', '#00FFFF'
                 ],
      on_start: function(){
            document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
      on_finish: function(){
            document.querySelector('#cursor-toggle').remove()
            }
    });
  }
}


/* Add breaks */
var breakMsg = {
  type: "html-keyboard-response",
  stimulus: ["<div class = 'center'><p style='font-size: 28px;'>This is a break.</p>\
  <p style='font-size: 24px;'>Press the space bar to continue.</p>"],
  choices: [32],
  timing_post_trial: 1600
}

/* Make sure participants are behaving */
var behave = {
    type: "html-keyboard-response",
    timeline: [{
      stimulus: "<div class = 'center'><p style='font-size: 28px;'>It seems that you have pressed the wrong \
  key many times recently.</p>\
  <p style='font-size: 28px;'>Please perform the task as accurately and as quickly as you can.</p>\
  <p style='font-size: 24px;'>Press the space bar to continue.</p>"
    }],
    choices: [32],
    conditional_function: function() {
      var trialType = jsPsych.currentTrial().type,
        trialN = jsPsych.data.get().filter({
          trial_type: "bRMS"
        }).count();

      if (trialType == 'bRMS' && // This isn't a break
        jsPsych.currentTrial().data.trial > lastWarned + experiment_performance_trials && // unwarned
        ((trialN >= experiment_performance_trials && // sufficient acc data
            jsPsych.data.get().filter({
              trial_type: "bRMS"
            }).last(experiment_performance_trials).select('acc').mean() < experiment_performance_thresh) || // performance bad
          (trialN >= experiment_RT_trials && // sufficient rt data
            jsPsych.data.get().filter({
              trial_type: "bRMS"
            }).last(experiment_RT_trials).filterCustom(function(x) {
              return x.rt < experiment_RT_threshold
            }).count() >= experiment_RT_trial_threshold))) { // enough fast trials
        lastWarned = jsPsych.currentTrial().data.trial;
        //console.log("condition is true");
        return true;
      } else {
        //console.log("condition is false");
        return false;
      }
    }
  },
  lastWarned = -experiment_performance_trials;

for (ii = breakEvery; ii < brms_task_stimuli.length; ii += (breakEvery + 1)) {
  brms_task_stimuli.splice(ii, 0, breakMsg);
};


for (ii = 1; ii < (brms_task_stimuli.length - 1); ii += 2) {
  brms_task_stimuli.splice(ii, 0, behave);
}


/* define block */
var bRMS_block = {
  timeline: brms_task_stimuli,
  visUnit: function() {
    return unitSize
  }  
};
//#endregion BRMS main task

//#endregion BRMS PART

//#region zoom/window/mturk record
var record_zoom_events = {
  type: 'call-function',
  func: function(){
    return JSON.stringify(zoom_event);
  }
}
var record_window_events = { // records window events
  type: 'call-function',
  func: function(){
    return jsPsych.data.getInteractionData().json();
  }
}

// Trial to write mturk data 
var turkInfo = jsPsych.turk.turkInfo();
var record_mturk_data = {
  type: 'call-function',
  func: function(){
    return JSON.stringify(turkInfo);
  }
}
//#endregion zoom/window/mturk record

//#region DEBRIEF
var scale_1 = [
  "1<br>Not at All",
  "2",
  "3",
  "4<br>Moderately",   
  "5",
  "6",
  "7<br>Extremely"
];
var debrief = {
  timeline: [
    {
      type: "html-keyboard-response",
      stimulus: "<div class='center'><p style='font-size: 28px;'>You have completed this part of the study!</p>\
                <p style='font-size: 28px;'>You will now answer several questions. Please answer them sincerely.</p> \
                <p style='font-size: 28px;'>We remind you that your answers are completely anonymous.</p>\
                <p style='font-size: 24px;'><i>Press the space bar to continue</i></p></div>",
      choices: [32]
    },
    {
      type: "survey-multi-choice",
      questions: [{
          prompt: "What is your gender?",
          options: ["Male", "Female", "Other"],
          required: true,
          name: "gender"
        },
        {
          prompt: "What is your dominant hand?",
          options: ["Right", "Left", "Both"],
          required: true,
          name: "hand"
        },
        {
          prompt: "Is English your native language?",
          options: ["Yes", "No"],
          required: true,
          name: "native"
        }
      ]
    },
    {
      type: "survey-text",
      questions: [{
          prompt: "How old are you?",
          columns: 20,
          rows: 1,
          value: '',
          name: "age",
          required: true
        }]
    },
    { 
        type: "survey-text",
        questions: [{
          prompt: 'Have you been diagnosed with, or believe you have an attention deficit disorder?',
          columns: 60,
          rows: 1,
          value: '',
          name: "add",
          required: true
        }]
          
    },    
    {
      type: 'survey-likert',
      questions: [{
        prompt: "How fluent are you in reading and understanding English?",
        labels: ["1<br>Not at all", "2", "3", "4", "5<br>Very fluent"],
        required: true,
        name: "fluency"
      }]
    },
    {
      type: 'survey-likert',
      questions: [{
        prompt: "How clear were the instructions to you in the first task" + q1,
        labels: ["1<br>Not at all", "2", "3", "4", "5<br>Absolutely clear"],
        required: true,
        name: "instructions_1"        
      }]
    },
    {
      type: 'survey-text',
      questions: [{
        prompt: "Did you have any special strategy that helped you detect \
                the " + q2 + " in the first task?",
        columns: 100,
        rows: 4,
        value: '',
        name: "strategy_1",
        required: true
      }]
    },
    {
      type: 'survey-likert',
      questions: [{
        prompt: "How clear were the instructions to you in the second task" + q3,
        labels: ["1<br>Not at all", "2", "3", "4", "5<br>Absolutely clear"],
        required: true,
        name: "instructions_2"        
      }]
    },
    {
      type: 'survey-text',
      questions: [{
        prompt: "Did you have any special strategy that helped you detect \
                the " + q4 + " in the second task?",
        columns: 100,
        rows: 4,
        value: '',
        name: "strategy_2",
        required: true
      }]
    },
    {
      type: 'survey-likert',
      questions: [
        {prompt: "<br><br>Do you seem to be aware of subtleties in your environment?", name: 'q1', labels: scale_1},
        {prompt: "<br><br>Are you easily overwhelmed by things like bright lights, strong smells, coarse fabrics, or sirens close by?", name: 'q2', labels: scale_1},
        {prompt: "<br><br>Do you have a rich, complex inner life?", name: 'q3', labels: scale_1},
        {prompt: "<br><br>Do you get rattled when you have a lot to do in a short amount of time?", name: 'q4', labels: scale_1},        
      ],
      randomize_question_order: false,
      required: true,
      name: "hsp1"
    },
    {
      type: 'survey-likert',
      questions: [
        {prompt: "<br><br>Are you deeply moved by the arts or music? ", name: 'q5', labels: scale_1},
        {prompt: "<br><br>Are you annoyed when people try to get you to do too many things at once?", name: 'q6', labels: scale_1},
        {prompt: "<br><br>Do you make a point to avoid violent movies and TV shows?", name: 'q7', labels: scale_1},
        {prompt: "<br><br>Do you find it unpleasant to have a lot going on at once?", name: 'q8', labels: scale_1},        
      ],
      randomize_question_order: false,
      required: true,
      name: "hsp2"
    },
    {
      type: 'survey-likert',
      questions: [
        {prompt: "<br><br>Do changes in your life shake you up?", name: 'q9', labels: scale_1},
        {prompt: "<br><br>Do you notice and enjoy delicate or fine scents, tastes, sounds, works of art?", name: 'q10', labels: scale_1},
        {prompt: "<br><br>Are you bothered by intense stimuli, like loud noises or chaotic scenes?", name: 'q11', labels: scale_1},
        {prompt: "<br><br>When you must compete or be observed while performing a task, do you become so nervous or shaky that you do much worse than you would otherwise?", name: 'q12', labels: scale_1}
      ],
      randomize_question_order: false,
      required: true,
      name: "hsp3"
    },
    {
        type: "survey-multi-choice",
        questions: [{
            prompt: "Do you have a driver’s license?",
            options: ["Yes", "No"],
            required: true,
            name: 'is_driver'
            }]
    }
    
    
]}



//#endregion DEBRIEF
var if_driver = {
    timeline: [{
        type: 'survey-likert',
        questions: [{
          prompt: "Compared to the average driver, how would you rate your own driving?", //*reverse scored
          labels: ["1<br>Much worse than average", "2", "3", "4", "5", "6", "7<br>Much better than average"],
          required: true
          }]
        },
        {
        type: "survey-text",
        questions: [{
          prompt: "In your best estimate, how many accidents were you involved in during the last three years as a driver, including minor accidents with no injuries or damage? (If none, mark 0)",
          columns: 20,
          rows: 1,
          value: ''
          }],     
        }
    ],
    conditional_function: function(){
        // get the data from the previous trial,
        // and check which key was pressed        
        if(JSON.parse(jsPsych.data.get().last(1).select('responses').values).is_driver == 'Yes'){
            return true;
        } else {
            return false;
        }
    }
}    

var get_code = {
    timeline: [        
        {
            type: "survey-text",
            questions: [{
                prompt: 'In your best estimate, how many accidents were you involved in during the last three years <b>as a pedestrian</b>,\
                    including minor accidents with no injuries or damage? (If none, mark 0)',
                columns: 60,
                rows: 1,
                value: ''
            }]
        },
        {
            type: 'survey-text',
            questions: [{
                prompt: "You have just participated in a pilot experiment.\
                        The aim of the study is to measure participant's ability to detect changes.\
                        Please write here any comments or suggestions that you think we should hear before issuing the full-scale experiment.",
                columns: 100,
                rows: 4,
                value: '',
                name: "comments"
                }]
        },
        {
            type: 'html-button-response',
            stimulus: '<p><b>xrVESi7LQxYmku5</b></p>',
            choices: ['Done'],
            prompt: "<p style='font-size: 28px;'>That's it, we're done! In order for your HIT to be submitted and for you to be paid, please copy the code above and paste it in the MTurk's HIT page.</p>"
        }
    ]
}

//INITIATE EXPERIMENT

var experiment_timeline = []
if (CONDITION == 1) {
  experiment_timeline = [introduction_procedure, CB_practice_procedure, CB_trial_procedure, middle_instructions, bRMS_instructions ,bRMS_secChanceLoop, bRMS_mainBlockIns, bRMS_block, record_zoom_events, record_window_events, record_mturk_data ,debrief, if_driver, get_code]
  } else {
    experiment_timeline = [introduction_procedure, bRMS_instructions ,bRMS_secChanceLoop, bRMS_mainBlockIns, bRMS_block, middle_instructions, CB_practice_procedure, CB_trial_procedure, record_zoom_events, record_window_events, record_mturk_data ,debrief, if_driver, get_code]
  }

jsPsych.init({
    timeline: experiment_timeline,
    on_finish: function() {
      alert("The experiment is over. Thank you for your participation!");
    },
    preload_images: pre_load_list
  });

</script>

</html>