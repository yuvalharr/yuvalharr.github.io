<!DOCTYPE html>
<html>
<head>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-resize.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-animation.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-virtual-chin.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-new-virtual-chin.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-new-resize.js"></script>
    
    <script src="jspsych-6.1.0/plugins/jspsych-brms.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-brms-test.js"></script>

    <script src= "jspsych-6.1.0/jquery.min.js"></script>
    <script src= "jspsych-6.1.0/jquery-ui.min.js"></script>
    <script src= "jspsych-6.1.0/svg.min.js"></script>
    <link href="jspsych-6.1.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"></link> 
    <link href="jspsych-6.1.0/css/jquery-ui.css" rel="stylesheet" type="text/css"></link>
    <link href="jspsych-6.1.0/css/styles.css" rel="stylesheet" type="text/css"></link>
    
    <!--
    <script src="jspsych-6.1.0/lib/jquery-min.js" type="text/javascript"></script>

    -->
  
    <script src="jspsych-6.1.0/lib/underscore-min.js" type="text/javascript"></script>
  
    <script src="jspsych-6.1.0/lib/backbone-min.js" type="text/javascript"></script>
  
    <script src="jspsych-6.1.0/lib/TweenMax.min.js"></script>
    <script src="jspsych-6.1.0/lib/CustomEase.js"></script>

    <script src="js/utils.js" type="text/javascript"></script> 
    

    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<body></body>

<script>
document.body.style.backgroundColor = "ghostwhite";

// YH- upload images 
function replicate(arr, times) { // function to help make array of many 'L's and 'R's 
     var al = arr.length,
         rl = al*times,
         res = new Array(rl);
     for (var i=0; i<rl; i++)
         res[i] = arr[i % al];
     return res;
}

var num_img_pairs = 2,   // ENTER NUMBER OF STIMULI HERE
    wrong_answers_message = 2, // at this num of wrong answers, every wrong answer will get a warning message (including this num)
    wrong_answers_abort = 4, // at this num of wrong answers, the exp will be aborted
    absent_images = [],
    present_images = [],
    detection_images = [],
    L_R_array = ['L', 'R'], // L & R array to replicate many times in the next row 
    random_var = replicate(L_R_array, num_img_pairs/2); // make half of the array 'L's and half 'R's
    random_var = jsPsych.randomization.shuffle(random_var); // random_var is now shuffled to assign each trial with L or R couple of images
for (i = 1; i <= num_img_pairs; i++) { //YH- creating two arrays -> one for all 'absent' and one for all 'present' images  -YH
  absent_images.push('img/0' + i + '_' + random_var[i-1] + '_filler_absent' + '.jpg');
  present_images.push('img/0' + i + '_' + random_var[i-1] + '_filler_present' + '.jpg');
  detection_images.push('detection grids/0' + i + random_var[i-1] + '.jpg')
}

// YH - make answers_L array *manually*. *** First value is column. second is row ***
answers_L =[]
answers_L.push([1,1]) // img_1
answers_L.push([1,3])
answers_L.push([1,2])
answers_L.push([1,0])
answers_L.push([0,3]) // img_5  
answers_L.push([0,2])
answers_L.push([1,2]) 
answers_L.push([1,2])
answers_L.push([0,1])
answers_L.push([0,0]) // img 10
answers_L.push([0,1])
answers_L.push([0,2])
answers_L.push([0,1])
answers_L.push([1,1])
answers_L.push([0,0]) // img 15  
answers_L.push([0,2])
answers_L.push([1,0])
answers_L.push([1,3])
answers_L.push([1,3])
answers_L.push([0,2]) // img 20 
answers_L.push([0,2])
answers_L.push([0,2])
answers_L.push([1,2])
answers_L.push([1,2])
answers_L.push([1,0]) // img 25
answers_L.push([1,1]) 
answers_L.push([0,1])
answers_L.push([0,2])
answers_L.push([0,2])
answers_L.push([1,0]) // img_30  
answers_L.push([0,2])
answers_L.push([1,1]) 
answers_L.push([0,2])
answers_L.push([0,0])
answers_L.push([1,2]) // img 35
answers_L.push([0,3])
answers_L.push([1,3])
answers_L.push([1,1])
answers_L.push([1,1])
answers_L.push([1,1]) // img 40 



// Make function to take L answers and make into R
function flipToR (L_ans) {
  var R_ans = []
  R_ans = L_ans
  if (R_ans[0] == 0) {
    R_ans[0] = 3
  } else {
    if (R_ans[0] == 1) {
      R_ans[0] = 2
    } else {
      if (R_ans[0] == 2) {
        R_ans[0] = 1
      } else {
        R_ans[0] = 0
      }
    }
  }
  return R_ans;
}

// Make answers_R array *automatically*
var answers_R = []
for (i = 0, len = answers_L.length; i < len; i++) {
    answers_R[i] = answers_L[i].slice();
}
for (i = 0; i < answers_L.length; i++) {
  answers_R[i] = flipToR (answers_R[i])
}

// YH- stimuli array preperation
var coupled = [];                  // make 'coupled' array -> each item is an array of coupled (a & b) images
for(var i=0; i < absent_images.length; i++){
   coupled.push([absent_images[i], present_images[i], detection_images[i]]);
   if (detection_images[i].slice(-5, -4) == "L") { // assign each coupled[i] with *only* its appropriate side answers (L or R)
     coupled[i].push(answers_L[i])
   } else {
    coupled[i].push(answers_R[i])
   }
}
coupled = jsPsych.randomization.shuffle(coupled); // shuffle 'coupled' array

// YH- prepare stimuli for the timeline in an array

var timeline_stimuli = []
var pre_load_list = []   // YH - array of images names for preload_images in the init function

for(var i=0; i < coupled.length; i++){     // make timeline - YH
    timeline_stimuli.push({stimuli: [coupled[i][0], coupled[i][0], coupled[i][1], coupled[i][1]], 
                             detection_image: [coupled[i][2]],
                             answers: coupled[i][3]
                             } 
                         );
    
    pre_load_list.push(timeline_stimuli[i]["stimuli"], timeline_stimuli[i]["detection_image"]);
}

// add zoom events

var zoom_event = [];

window.onresize = function(){
  console.log(window.devicePixelRatio);
  zoom_event.push({timestamp: performance.now(), zoom_ratio: window.devicePixelRatio});
}


var preCalibInsText = [{
    stimulus: ["<div class='center'>Welcome to the study!<br> \
    <p>Your participation will help us investigate human precision and reaction-times.</p>\
    <p >Please read the instructions carefully.</p>\
    <p align='center'><i>Press the space bar to continue</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class='center'><p>In order to begin, \
      we first need to measure the size of your screen and the distance you are sitting from it.</p>\
      <p>This will allow us to calibrate the experiment's presentation size specifically for you.</p>\
      <p>After this short calibration, we will continue with the main task of \
      this study.</p>\
      <p align='center'><i>Press the space bar to continue</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class='center'><p>First, please adjust your web browser's zoom level to 100%, and set your screen brightness to the maximum level.</p>\
      <p>We ask you to not change this throughout the whole course of the experiment.</p>\
      <p align='center'><i>Press the space bar to continue</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class='center'><p>For the calibration stage, you will need a credit card.</p>\
      <p>Don't worry, the credit card will be used just as a size measuring tool.</p>\
      <p>Any credit card will do.</p>\
      <p align='center'><i>Press the space bar to continue</i></p></div>"],
    choices: [32]
  }/**,
  {
    stimulus: ["<div class='center'><p>Using your mouse, \
      you will be asked to adjust the size of an empty box, so that it matches the \
      size of your credit card.</p>\
      <p>Take your time in doing so, as this measurement\
      will be used throughout the \
      study to make sure images are presented to \
      you in their correct size.</p>\
      <p align='center'><i>Press the space bar to start the calibration stage</i></p></div>"],
    choices: [32]
  }**/
  
];

var instructionsText = [
  {
    stimulus: ["<p style='font-size: 28px;'>We finished the calibration stage! We will now continue to the main task of this experiment.</p>\
                <p style='font-size: 28px;'><b>We remind you to make an effort to move as little as possible until the end of the task.</b></p>\
                <p style='font-size: 28px;'><b>Please read the following instructions carefully.</b></p>\
    <p style='font-size: 24px;'><i>Press the space bar to continue to the instructions</i></p>"],
    choices: [32]
  },
  {
    stimulus: ["<p style='font-size: 28px;' align='justify'>In this part you will be asked to find a single flickering object within a scene.\
    Each time you will be presented with one scene. This scene will be static, except for one single object that will be appearing and disappearing.\
    Your goal will be to detect this object as quickly and accurately as you can. We will ask you to place your finger over the space bar, and once you have found the object press the space bar <b>as quickly as possible.</b></p>\
    <p style='font-size: 28px;' align='justify'>For each scene, you will have 60 seconds to do so. After that you will be asked about the location of the object.</P>\
    <p style='font-size: 28px;' align='justify'>We will now continue with a short practice before starting the main task.</p>\
    <p style='font-size: 24px;'><i>Press the space bar to continue</i></p>"],
    choices: [32]
  }
  
  
];

var inPracticeText = [
  {
    stimulus: ["<p style='font-size: 28px;'>That was easy, right?</p>\
                <p style='font-size: 28px;'>Now let's have another practice. This time it will be a bit more difficult.</p>\
                <p style='font-size: 24px;'><i>Press the space bar to continue</i></p>"],
    choices: [32]
  }
    
];

var afterPracticeText = [
  {
    stimulus: ["<p style='font-size: 28px;'>Great! You are now ready to continue to the main task.</p>\
                <p style='font-size: 28px;'>You will now be shown a series of similar trials one after another.</p>\
                <p style='font-size: 28px;'>It will take about 10-15 minutes until the next break.</p>\
                <p style='font-size: 28px;'>We ask you to keep your finger over the space bar and stay concentrated the whole time.</p>\
                <p style='font-size: 24px;'><i>Press the space bar when ready</i></p>"],
    choices: [32]
  }
    
];




var introduction_procedure = {
    timeline: [
        {
            type: 'fullscreen',
            fullscreen_mode: true,
            message: '<p>This experiment has to be performed on full-screen mode.</p>\
            <p>Please do not leave full-screen mode at any time throughout the experiment.</p>',
            button_label: 'Enter full-screen'
        },
        {
            type: 'call-function',
            func: function() {
                var urlvar = jsPsych.data.urlVariables();
                var id = urlvar.id
                var card_width_px = Number(urlvar.width)
                var distance = Number(urlvar.distance)
                jsPsych.data.addProperties({subject_id: id, card_width_px: card_width_px, distance: distance});
            }
        },
        {
            type: 'html-keyboard-response',
            timeline: preCalibInsText,
            timing_post_trial: 400
        },
        {
            type: 'new-resize',
            item_width: 3 + 3/8,
            item_height: 2 + 1/8,
            prompt: "<p>Click and drag</p>",
            pixels_per_unit: 150, // YH - check what to put here
            card_width_px: function(){  
              var last_trial_card_width =  jsPsych.data.get().last(2).values()[0].card_width_px; // card width in px from previous trial
              return last_trial_card_width; 
            } 
        }, 
        {
            type: 'animation',    // YH -this trial is here just to enable exp to advance from virtual-chin to html-keyboard-response- YH **
            stimuli: ['img/demo1_absent.jpg'],
            choices: [32],
            sequence_reps: 1,
            frame_isi: 0,
            frame_time: 0.1,
            prompt: '<p style="font-size: 28px;"></p>',
        },
        {
            type: 'html-keyboard-response',
            timeline: instructionsText,
            timing_post_trial: 400
        }        
    ]
}

var practice_procedure = {
    timeline: [
        {
            type: 'animation',
            stimuli: ['img/demo1_absent.jpg','img/demo1_absent.jpg', 'img/demo1_present.jpg', 'img/demo1_present.jpg'],
            choices: [32],
            sequence_reps: 30,
            frame_isi: 0,
            frame_time: 500,
            prompt: '<p></p> \<p style="font-size: 28px;">Press the <b>space bar</b> quickly after finding the flickering object</p>',
            on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
            on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            }

        },
        {
            type: 'image-button-response',
            stimulus: ['detection grids/demo1.jpg'],
            choices: ['A', 'B', 'C', 'D', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>column</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px'
        },
        {
            type: 'image-button-response',
            stimulus: ['detection grids/demo1.jpg'],
            choices: ['1', '2','3','4', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>row</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px'
        },
        {
            type: 'html-keyboard-response',
            timeline: inPracticeText,
            timing_post_trial: 1200
        },
        {
            type: 'animation',
            stimuli: ['img/demo2_absent.jpg','img/demo2_absent.jpg', 'img/demo2_present.jpg', 'img/demo2_present.jpg'],
            choices: [32],
            sequence_reps: 47, 
            frame_isi: 80,
            frame_time: 240,
            timing_post_trial: 1200,
            prompt: '<p style="font-size: 28px;">Press the <b>space bar</b> quickly after finding the flickering object</p>',
            on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
            on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            }
        },
        {
          type: 'image-keyboard-response',
            stimulus: ['detection grids/demo2.jpg'],
            choices: [32],
            prompt: '<p></p> \
                    <p style="font-size: 24px">When asked about the location, sometimes more then one answer may seem possible.<br>\
                     In any case like this, choose the option in which the major part of the object is located.</p>\
                     <p style="font-size: 24px">Press the space bar to continue</p>',
            stimulus_width: '900'
        },
        {
            type: 'image-button-response',
            stimulus: ['detection grids/demo2.jpg'],
            choices: ['A', 'B', 'C', 'D', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>collumn</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px'
        },
        {
            type: 'image-button-response',
            stimulus: ['detection grids/demo2.jpg'],
            choices: ['1', '2','3','4', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>row</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px'
        },
        {
            type: 'html-keyboard-response',
            timeline: afterPracticeText,
            
        }

    ]
}

var warning_trial = {      // warning message to display after too many wrong answers
    type: 'html-keyboard-response',
    stimulus: "<div class = 'center'><p style='font-size: 28px;'>It seems that you are not performing the task as instructed.</p>\
      <p style='font-size: 28px;'>You are reminded to press the space bar only if you have spotted the flickering object.</p>\
      <p style='font-size: 28px;'>If it keeps recurring we might need to end the experiment.</p> \
      <p style='font-size: 24px;'><i>Press the space bar to continue</i></p>",
    on_finish: function() {
      new_wrong_answers--;
    }
      
}

var abort_trial = {
  type: 'html-keyboard-response',
  stimulus: "<div class = 'center'><p style='font-size: 28px;'>The task is still not being performed as instructed despite multiple warnings.</p> \
            <p style='font-size: 28px;'>The experiment will be aborted now.</p> \
            <p style='font-size: 28px;'>If you feel that this is a mistake, please email us at <i>yuval.harris@mail.huji.ac.il</i>.</p> \
            <p style='font-size: 24px;'>Press the space bar to quit</p>",
  choices: [32],
  on_finish: function(){
    jsPsych.endExperiment('The experiment was aborted');
  } 
}

var new_wrong_answers = 0; // num of wrong answers used to display warning message when needed. after each message will decrease by 1 to allow trials with unnecessary message
var total_wrong_answers = 0; // total num of wrong answers (never decreases)

var trial_procedure = {
    timeline: [
        {
              
              type: "call-function",
              async: true,
              func: function(done) {
                jsPsych.pluginAPI.preloadImages(jsPsych.timelineVariable('stimuli', true), function() {
                  done({ preload: "success" });
                })
                jsPsych.pluginAPI.preloadImages(jsPsych.timelineVariable('detection_image', true), function() {
                  done({ preload: "success" });
                })
              }

        },
        {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">ready?</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
            prompt: '<p style="font-size: 36px;">3</p>',
            on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            }
        },
        {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">ready?</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 200,
            prompt: '<p style="font-size: 36px;">3</p>'
        },
        {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">ready?</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 200,
            prompt: '<p style="font-size: 36px;">2</p>'
        },
        {
            type: 'html-keyboard-response',
            stimulus: '<p style="font-size: 48px;">ready?</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 200,
            prompt: '<p style="font-size: 36px;">1</p>',
            post_trial_gap: 0
        },
        {
            type: 'animation',
            stimuli: jsPsych.timelineVariable('stimuli'),
            choices: [32],
            sequence_reps: 47,
            frame_isi: 80,
            frame_time: 240,
            data: {
              col_row_answers: jsPsych.timelineVariable('answers')
              },
            on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            }
        },
        {
            type: 'image-button-response',
            stimulus: jsPsych.timelineVariable('detection_image'),
            choices: ['A', 'B', 'C', 'D', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>column</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px',
            on_finish: function(data) {
                if ( data.button_pressed == jsPsych.data.get().last(2).values()[0].col_row_answers[0] ) { // if button pressed was correct 
                  data.correct_response = true;
                } else {
                  data.correct_response = false;
                  if (jsPsych.data.get().last(2).values()[0].rt ) {   // only if there was response during trial (=rt exists),
                    total_wrong_answers++; // if wrong, add 1 to wrong answers count
                    new_wrong_answers++;
                  }
                }
            }
        },
        {
            type: 'image-button-response',
            stimulus: jsPsych.timelineVariable('detection_image'),
            choices: ['1', '2','3','4', "Don't know"],
            prompt: '<p style="font-size: 28px;margin-top: 0px;margin-bottom: 0px;">In what <b>row</b> is the flickering object located?</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            stimulus_width: '900',
            margin_horizontal: '50px',
            margin_vertical: '20px',
            on_finish: function(data) {
                var all_data = jsPsych.data.get().values();
                if ( data.button_pressed == jsPsych.data.get().last(3).values()[0].col_row_answers[1] ) { //if button pressed is correct
                  data.correct_response = true;
                  if (jsPsych.data.get().last(2).values()[0].correct_response == true) { // If both grids were correct ->
                    
                    // go back 2 trials, which means subtracting 2 from the array length, and 1 more to account for the 0 indexing
                    all_data[all_data.length-3].success = true; 
                  } else {
                    all_data[all_data.length-3].success = false; 
                  }
                } else {
                  all_data[all_data.length-3].success = false; 
                  data.correct_response = false;
                  if (jsPsych.data.get().last(3).values()[0].rt ) { // only if there was response during trial (rt exists)
                    if (jsPsych.data.get().last(2).values()[0].correct_response == true) { // in the second grid trial, add 1 only if previous grid was
                      total_wrong_answers++;                                                 //  correct, to not count twice wrong answers in same stimuli.
                      new_wrong_answers++;
                  }
                  
                  }
                }
            }
        },
        {
            timeline: [abort_trial],
            conditional_function: function(){
                if (jsPsych.data.get().last(3).values()[0].responses) {
                  if (total_wrong_answers >= wrong_answers_abort) {
                    return true
                  } else {
                     return false
                  }
                } else {
                  return false
                }          
            }
        },
        {
            timeline: [warning_trial],
            conditional_function: function(){
                if (jsPsych.data.get().last(3).values()[0].responses) {
                  if (new_wrong_answers >= wrong_answers_message) {
                    return true;
                  } else {
                     return false
                  }
                } else {
                  return false
                }          
            }
        }
    ],
    timeline_variables: timeline_stimuli // Declare timeline_stimuli as timeline of the experiment
}



/** -------------------------------------------------------------------------------------------------------------------------- **/
//#region -------------------------------------------------- BRMS PART -------------------------------------------------------
 

// Parameters
var ITI = 1000,
  time_limit = 60 * (60 * 1000),
  stimAlphas = 0.4,
  unitSize = 4,
  breakEvery = 50,
  exp_num_faces = 50, // number of different faces to use per experiment  *yuval
  repetitions = 4, // number of repetitions of each face   *yuval
  total_num_faces = 300, // total number of faces in the database (e.g 300- for one gender only) (images file) *yuval
  train_repetitions = 3,
  train_alpha = 0.4,
  trialLength = 0, // 0 is no limit
  fade_in_time = 1,
  fade_out_time = 15,
  fade_out_length = 5,
  training_allowed_repeat = 1,
  experiment_performance_thresh = .85,
  experiment_performance_trials = 20,
  train_performance_thresh = .60,     ///////remember to return to 0.85
  experiment_RT_trials = 8,
  experiment_RT_trial_threshold = 5,
  experiment_RT_threshold = 300,
  sProblemCrit = 8,
  bProblemCrit = 2;


var brms_trial = {
          type: "bRMS",
          stimulus: "face.jpg",
          timing_post_trial: 100,
          visUnit: 5,
          within_ITI: 200,
          timing_response: trialLength,
          fade_out_time: fade_out_time,
          fade_in_time: fade_in_time,
          fade_out_length: fade_out_length,
          stimulus_alpha: train_alpha,
          colorOpts: ['#FF0000', '#00FF00', '#0000FF',
                       '#FFFF00', '#FF00FF', '#00FFFF'
                     ],
          on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
          on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            }
}

//#region BRMS practice

var instruction_text = [{
    stimulus: ["<p>First part is done!</p>\
    <p>You've finished about half of the study, great job!</p>\
    <p align='center'><i>Press the space bar to continue.</i></p>"],
    choices: [32]
  },
  {
    stimulus: ["<p>We will now go on to the second task.</p>\
    <p>Please read the following instructions carefully.</p>\
    <p align='center'><i>Press the space bar to continue.</i></p>"],
    choices: [32]
  },
  {
    stimulus: ["<div class = 'center'><p>In this task you will be presented with rapidly \
      changing patterns of rectangles. Through these rectangles faces will appear. Your task will be to indicate the location of \
      the faces, or any part of them, as soon as they appear.</p>\
      <p align='center'><i>Press the space bar to continue.</i></p></div>"
    ],
    choices: [32]
  },
  {
    stimulus: ["<div class = 'center'><p>If a face appeared in the right half \
      of the screen, press the right key. If a face appeared in the left half \
      of the screen, press the left key.</p>\
      <p align='center'><i>Press the space bar to continue.</i></p></div>"
    ],
    choices: [32]
  } ,
  {
    stimulus: ["<div class = 'center'><p>Please perform this task as accurately \
      and quickly as you can.</p>\
      <p align='center'><i>Press the space bar to continue.</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class = 'center'><p>During the task, please focus your gaze at\
       the plus sign in the middle.<br>Even though the faces appear to the left\
        and right of the plus sign, it is important that you look at the plus \
        sign at all times.</p>\
        <p align='center'></i>Press the space bar to continue.</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class = 'center'><p>We will start with a short practice.</p>\
        <p align='center'></i>Press the space bar to continue.</i></p></div>"],
    choices: [32]
  },
  {
    stimulus: ["<div class='center'>\
      <img src='keys.jpg'></img>\
      <p>Place your fingers on the 'D' and 'K' keys as shown in the picture, \
      and press either one of these keys to start the practice.</p></div>"],
    choices: [68, 75]
  }
];

var brms_instructions = {
  type: 'html-keyboard-response',
  timeline: instruction_text,
  timing_post_trial: 200
};

var bRMS_practice_procedure = {
  timeline: [
    {
      type: "bRMS",
      stimulus: jsPsych.timelineVariable('stimuli'),
      timing_response: trialLength,
      fade_out_time: fade_out_time,
      fade_in_time: fade_in_time,
      fade_out_length: fade_out_length,
      stimulus_alpha: train_alpha,
      timing_post_trial: 100,
      visUnit: function() {
        return unitSize
      },
      within_ITI: ITI - 100,
      colorOpts: ['#FF0000', '#00FF00', '#0000FF',
                       '#FFFF00', '#FF00FF', '#00FFFF'
                     ],
      on_start: function(){
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
      on_finish: function(){
                document.querySelector('#cursor-toggle').remove()
            },
      data: {
          //stimulus: jsPsych.timelineVariable('practice_stimuli'),
          stimulus_type: 'training',
          timing_response: trialLength,
          fade_out_time: fade_out_time,
          fade_in_time: fade_in_time,
          fade_out_length: fade_out_length,
          stimulus_alpha: train_alpha
      } 
    }
  ],
  timeline_variables: [
    {stimuli: "face.jpg"},
    {stimuli: "card.png"}
  ],
  randomize_order: true,
  repetitions: train_repetitions
};
 
var performanceMSG_practice = {
    type: 'html-keyboard-response',
    stimulus: ["<div class='center'>\
  <p>You pressed the wrong key too many times during the practice block.</p>\
  <p>Press either the 'D' or 'K' keys to repeat it.</p></div>"],
    choices: [68, 75],
    on_start: function(trial) {
      if (jsPsych.data.get().last(1).select('trial_type').values != 'bRMS') {
        trial.stimulus = '';
        trial.choices = jsPsych.NO_KEYS;
        trial.trial_duration = 0;
      }
    }
  },
  stop_practice_loop = {
    type: 'html-keyboard-response',
    conditional_function: function() {
      if (jsPsych.data.get().last(1).select('train_repeats').values[0] > training_allowed_repeat) {
        return true;
      } else {
        return false;
      }
    },
    timeline: [{
      stimulus: "<div class='center'>\
  <p>It seems that you are not performing the task as instructed.</p>\
  <p>Please return this study.</p>\
  <p>If you feel that this is a mistake, please email \
  yuval.harris@mail.huji.ac.il</p>\
  <p>Press the space bar to continue.</p></div>"
    }],
    choices: [32],

    //** needed eventualy **//
    on_finish: function() {
          jsPsych.endExperiment('The experiment was aborted');  
			}
	}



jsPsych.data.addProperties({
  train_repeats: 1
});

var secChanceLoop = {
  timeline: [performanceMSG_practice, bRMS_practice_procedure, stop_practice_loop],
  loop_function: function() {
    if (jsPsych.data.get().last(train_repetitions).select('acc').mean() < train_performance_thresh) {
      jsPsych.data.addProperties({
        train_repeats: jsPsych.data.get().last(1).select('train_repeats').values[0] + 1
      });
      return true
    } else {
      return false
    }
  }
};
//#endregion BRMS practice
//region BRMS main task

var mainBlockText = [{
    stimulus: ["<div class = 'center'><p>You have completed the practice block.</p>\
  <p>You will now continue with the same task. The task may now be more \
  difficult.\
  You will have 3 short breaks. </p>\
    <p>Press either the 'D' or the 'K' keys to continue.</p></div>"],
    choices: [68, 75]
  },
  {
    stimulus: ["<div class = 'center'><p>During the task, please focus your gaze at\
   the plus sign in the middle.<br>Even though the faces appear to the left\
    and right of the plus sign, it is important that you look at the plus \
    sign at all times.</p>\
    <p>Press either the 'D' or the 'K' keys to continue.</p></div>"],
    choices: [68, 75]
  }
]

var mainBlockIns = {
  type: 'html-keyboard-response',
  timeline: mainBlockText,
  timing_post_trial: 200
}

//** 6------------brms main block**//

// Define stimuli for bRMS

var used_images = ["f001.jpg","f002.jpg", "m001.jpg", "m002.jpg"] //creating 'used_images[]', holding all and only faces going to be used in the main block. *yuval
var brms_task_stimuli = [];


for (i = 0; i < repetitions; i++) { // Create a list of trials, repeating the experiment block x amount of times. *yaniv
  used_images = jsPsych.randomization.shuffle(used_images); //shuffling again for next repeats  *yuval
  for (ii = 0; ii <= used_images.length - 1; ii++) {
    brms_task_stimuli.push({
      type: "bRMS",
      stimulus: used_images[ii],
      data: {
        stimulus: used_images[ii],
        timing_response: trialLength,
        stimulus_alpha: stimAlphas,
        timing_post_trial: 100,
        within_ITI: ITI - 100,
        fade_in_time: fade_in_time,
        fade_out_time: fade_out_time,
        fade_out_length: fade_out_length,
        trial: (i * used_images.length) + ii + 1 // set trial number in data (example: 301,302...) *yuval
	    },
      stimulus_alpha: stimAlphas,
      timing_post_trial: 100,
      within_ITI: ITI - 100,
      timing_response: trialLength,
      fade_in_time: fade_in_time,
      fade_out_time: fade_out_time,
      fade_out_length: fade_out_length,
      colorOpts: ['#FF0000', '#00FF00', '#0000FF',
                       '#FFFF00', '#FF00FF', '#00FFFF'
                 ],
      on_start: function(){
            document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>')
            },
      on_finish: function(){
            document.querySelector('#cursor-toggle').remove()
            }
    });
  }
}


/* Add breaks */
var breakMsg = {
  type: "html-keyboard-response",
  stimulus: ["<div class = 'center'><p>This is a break.</p>\
  <p>Press the space bar to continue.</p>"],
  choices: [32],
  timing_post_trial: 1600
}

/* Make sure participants are behaving */
var behave = {
    type: "html-keyboard-response",
    timeline: [{
      stimulus: "<div class = 'center'><p>It seems that you have pressed the wrong \
  key many times recently.</p>\
  <p>Please perform the task as accurately and as quickly as you can.</p>\
  <p>Press the space bar to continue.</p>"
    }],
    choices: [32],
    conditional_function: function() {
      var trialType = jsPsych.currentTrial().type,
        trialN = jsPsych.data.get().filter({
          trial_type: "bRMS"
        }).count();

      if (trialType == 'bRMS' && // This isn't a break
        jsPsych.currentTrial().data.trial > lastWarned + experiment_performance_trials && // unwarned
        ((trialN >= experiment_performance_trials && // sufficient acc data
            jsPsych.data.get().filter({
              trial_type: "bRMS"
            }).last(experiment_performance_trials).select('acc').mean() < experiment_performance_thresh) || // performance bad
          (trialN >= experiment_RT_trials && // sufficient rt data
            jsPsych.data.get().filter({
              trial_type: "bRMS"
            }).last(experiment_RT_trials).filterCustom(function(x) {
              return x.rt < experiment_RT_threshold
            }).count() >= experiment_RT_trial_threshold))) { // enough fast trials
        lastWarned = jsPsych.currentTrial().data.trial;
        //console.log("condition is true");
        return true;
      } else {
        //console.log("condition is false");
        return false;
      }
    }
  },
  lastWarned = -experiment_performance_trials;

for (ii = breakEvery; ii < brms_task_stimuli.length; ii += (breakEvery + 1)) {
  brms_task_stimuli.splice(ii, 0, breakMsg);
};


for (ii = 1; ii < (brms_task_stimuli.length - 1); ii += 2) {
  brms_task_stimuli.splice(ii, 0, behave);
}


/* define block */
var bRMS_block = {
  timeline: brms_task_stimuli,
  visUnit: function() {
    return unitSize
  }  
};

//#endregion BRMS main task

//#region BRMS animation test
//** Animation test ** //
var test_animation = {
    type: 'bRMS-test',
    timeline: [{
        stimulus: "f001.jpg",
        prompt: "<p>Testing for the \
      compatibility of your personal computer with this study.</p> \
      <p>This will take approximately 15 seconds more.</p>"
      },
      {
        stimulus: "f002.jpg",
        prompt: "<p>Testing for the \
      compatibility of your personal computer with this study.</p> \
      <p>This will take approximately 10 seconds more.</p>"
      },
      {
        stimulus: "m001.jpg",
        prompt: "<p>Testing for the \
      compatibility of your personal computer with this study.</p> \
      <p>This will take approximately 5 seconds more.</p>"
      }
    ],
    data: {
      timing_response: 4,
      stimulus_alpha: stimAlphas,
      timing_post_trial: 100,
      within_ITI: ITI - 100,
      fade_in_time: fade_in_time,
      fade_out_time: fade_out_time,
      fade_out_length: fade_out_length
	},
    stimulus_alpha: stimAlphas,
    timing_post_trial: 100,
    within_ITI: ITI - 100,
    timing_response: 4,
    fade_in_time: fade_in_time,
    fade_out_time: fade_out_time,
    fade_out_length: fade_out_length,
    visUnit: 4,
    choices: ["none"],
    colorOpts: ['#FF0000', '#00FF00', '#0000FF',
                       '#FFFF00', '#FF00FF', '#00FFFF'
                     ]
  },
  poor_animation = {
    type: 'html-keyboard-response',
    conditional_function: function() {
      if (jsPsych.data.get().last(3).select('sProblem').sum() > sProblemCrit ||
        jsPsych.data.get().last(3).select('bProblem').sum() > bProblemCrit) {
        return true;
      } else {
          console.log ('hellohellohello')
        return false;
      }
    },
    timeline: [{
      stimulus: "<div class = 'center'>\
<p>It seems that the animation is not presented correctly on your computer.</p>\
<p>This may be due to old hardware, or too many open applications.</p>\
<p><b>Please return this study</b>.</p>\
<p>We'll be glad to see you participating in future studies.</p>\
<p>For any questions, please email \
yuval.harris@mail.huji.ac.il</p>\
<p>Press the space bar to continue.</p></div>"
    }],
    choices: [32],
    //** needed eventualy **//
    on_finish: function() {			 
			 jsPsych.endExperiment('The experiment has been aborted');
			}
  }
//#endregion BRMS animation test
//#endregion ---------------------------------------------------BRMS PART----------------------------------------------



// Trial to write all zoom events to data
// this will store the zoom_event data in the data for this trial.
var record_zoom_events = {
  type: 'call-function',
  func: function(){
    return JSON.stringify(zoom_event);
  }
}
var record_window_events = { // records window events
  type: 'call-function',
  func: function(){
    return jsPsych.data.getInteractionData().json();
  }
}

// Trial to write mturk data 
var turkInfo = jsPsych.turk.turkInfo();
var record_mturk_data = {
  type: 'call-function',
  func: function(){
    return JSON.stringify(turkInfo);
  }
}

//** 7---------Debrief **//

var debrief = {
  timeline: [
    {
      type: "html-keyboard-response",
      stimulus: "<div class='center'><p style='font-size: 28px;'>You have completed this part of the study!</p>\
                <p style='font-size: 28px;'>You will now answer several questions. Please answer them sincerely.</p> \
                <p style='font-size: 28px;'>We remind you that your answers are completely anonymous.</p>\
                <p style='font-size: 24px;'><i>Press the space bar to continue</i></p></div>",
      choices: [32]
    },
    {
      type: "survey-multi-choice",
      questions: [{
          prompt: "What is your gender?",
          options: ["Male", "Female", "Other"],
          required: true,
          name: "gender"
        },
        {
          prompt: "What is your dominant hand?",
          options: ["Right", "Left", "Both"],
          required: true,
          name: "hand"
        },
        {
          prompt: "Is English your native language?",
          options: ["Yes", "No"],
          required: true,
          name: "native"
        }
      ]
    },
    {
      type: "survey-text",
      questions: [{
          prompt: "How old are you?",
          columns: 20,
          rows: 1,
          value: '',
          name: "age",
          required: true
        }]
    },
    { type: "survey-text",
    questions: [{
          prompt: 'Have you been diagnosed with, or believe you have an attention deficit disorder?',
          columns: 60,
          rows: 1,
          value: '',
          name: "add",
          required: true
        }]
          
    },    
    {
      type: 'survey-likert',
      questions: [{
        prompt: "How fluent are you in reading and understanding English?",
        labels: ["1<br>Not at all", "2", "3", "4", "5<br>Very fluent"],
        required: true,
        name: "fluency"
      }]
    },
    {
      type: 'survey-likert',
      questions: [{
        prompt: "How clear were the instructions to you?",
        labels: ["1<br>Not at all", "2", "3", "4", "5<br>Absolutely clear"],
        required: true,
        name: "instructions"
        
      }]
    },
    {
      type: 'survey-text',
      questions: [{
        prompt: "Did you have any special strategy that helped you seeing \
                the objects more quickly?",
        columns: 100,
        rows: 4,
        value: '',
        name: "strategy",
        required: true
      }]
    },
    {
      type: 'survey-text',
      questions: [{
        prompt: "You have just participated in a pilot experiment.\
                The aim of the study is to measure participant's ability to detect changes in a scene.\
                Please write here any comments or suggestions that you think we should hear before issuing the full-scale experiment.",
        columns: 100,
        rows: 4,
        value: '',
        name: "comments"
      }]
    },
    {
      type: 'survey-text',
      questions: [{
        prompt: "Please enter your MTurk Worker ID",
        columns: 18,
        rows: 1,
        value: ''
      }]
    },
    
]}

//** 8--------- mTurk Code **//

var get_code = {
    type: 'html-button-response',
    stimulus: '<p><b>xrVESi7LQxYmku5</b></p>',
    choices: ['Done'],
    prompt: "<p>In order for your HIT to be submitted and for you to be paid, please copy the code above and paste it in the MTurk's HIT page.</p>"
};

jsPsych.init({
    timeline: [test_animation,poor_animation, introduction_procedure,practice_procedure, trial_procedure, brms_instructions ,secChanceLoop, mainBlockIns, bRMS_block, /**record_zoom_events, record_window_events, record_mturk_data ,**/ debrief, get_code],
    on_finish: function() {
      alert("The experiment is over. Thank you for your participation!");
    },
    preload_images: pre_load_list
  });

</script>

</html>